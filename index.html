<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blockout 3D - Demo Bot Visual Completo</title>
    <style>
      :root {
        color-scheme: dark;
      }

      body {
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 24px;
        background: #05060a;
        color: #f3f5ff;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px;
      }

      h1 {
        margin: 0;
        font-size: 2.4rem;
        color: #6ef2ff;
      }

      p {
        margin: 0;
        color: #cdd5ff;
      }

      #game-wrapper {
        display: flex;
        gap: 32px;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
      }

      canvas {
        display: block;
        border-radius: 10px;
        background: #000;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.55);
      }

      #screen {
        border: 2px solid rgba(110, 242, 255, 0.35);
      }

      #screen2 {
        border: 2px solid rgba(255, 255, 255, 0.1);
        background: #07090f;
        width: 90px;
        height: 500px;
      }

      #hud {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        width: 100%;
      }

      #hud span {
        background: rgba(255, 255, 255, 0.08);
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 1.1rem;
        min-width: 140px;
        text-align: center;
      }

      #controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
      }

      button,
      select {
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.06);
        color: #f3f5ff;
        padding: 10px 18px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      button:hover,
      select:hover,
      button.on {
        border-color: #6ef2ff;
        background: rgba(110, 242, 255, 0.15);
      }

      #log-sequence {
        width: min(100%, 900px);
        border: 1px solid rgba(110, 242, 255, 0.3);
        border-radius: 10px;
        padding: 20px;
        background: rgba(7, 9, 15, 0.9);
      }

      #log-sequence h2 {
        margin-top: 0;
        color: #6ef2ff;
      }

      #log-sequence code {
        display: block;
        background: rgba(255, 255, 255, 0.05);
        padding: 6px 10px;
        border-radius: 6px;
        margin-bottom: 4px;
        font-size: 0.9rem;
      }

      .tip {
        font-size: 0.95rem;
        opacity: 0.85;
      }
    </style>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="js/engine.js"></script>
    <script src="js/bot.js"></script>
    <script>
      function resolveCanvasAndContext() {
        var canvas = document.getElementById('screen');
        if (!canvas) {
          throw new Error('[Demo UI] No se encontr√≥ el canvas principal');
        }
        var ctx = canvas.getContext('2d');
        if (!ctx) {
          throw new Error('[Demo UI] No se pudo obtener el contexto 2D');
        }
        return { canvas: canvas, ctx: ctx };
      }

      function applyPitFromSelect() {
        var val = document.getElementById('pitSizeSelect').value;
        var fakeEl = { innerHTML: val.toLowerCase() };
        var env = resolveCanvasAndContext();
        change_pit(fakeEl, env.canvas, env.ctx);
        reset_allowed();
        if (DEMO_MODE) {
          startDemo();
        }
      }

      function applySpeedFromSelect() {
        var speed = document.getElementById('speedSelect').value;
        setRotateSpeed(speed);
        console.log('[UI] Velocidad configurada en', speed);
      }

      function startDemo() {
        var env = resolveCanvasAndContext();
        console.log('[DEMO] startDemo solicitado. DEMO_MODE =', DEMO_MODE);

        if (typeof ID1 !== 'undefined' && ID1 !== -1) {
          clearInterval(ID1);
          ID1 = -1;
        }
        if (typeof ID2 !== 'undefined' && ID2 !== -1) {
          clearTimeout(ID2);
          ID2 = -1;
        }

        DEMO_MODE = true;
        document.getElementById('demoStartBtn').classList.add('on');
        document.getElementById('demoStopBtn').classList.remove('on');

        try {
          play_game(env.canvas, env.ctx, function () {});
          console.log('[DEMO] DEMO iniciado correctamente.');
        } catch (error) {
          console.error('[DEMO] Error al iniciar el DEMO:', error);
          DEMO_MODE = false;
          document.getElementById('demoStartBtn').classList.remove('on');
          document.getElementById('demoStopBtn').classList.add('on');
          throw error;
        }
      }

      function stopDemo() {
        var env = resolveCanvasAndContext();
        console.log('[DEMO] stopDemo solicitado. DEMO_MODE =', DEMO_MODE);
        DEMO_MODE = false;
        document.getElementById('demoStartBtn').classList.remove('on');
        document.getElementById('demoStopBtn').classList.add('on');

        if (typeof ID1 !== 'undefined' && ID1 !== -1) {
          clearInterval(ID1);
          ID1 = -1;
        }
        if (typeof ID2 !== 'undefined' && ID2 !== -1) {
          clearTimeout(ID2);
          ID2 = -1;
        }

        try {
          game_over(env.canvas, env.ctx);
        } catch (error) {
          console.error('[DEMO] Error al detener el DEMO:', error);
        }
      }

      function resetDemo() {
        stopDemo();
        startDemo();
      }

      function forceNewPiece() {
        var env = resolveCanvasAndContext();
        new_piece(env.canvas, env.ctx);
      }

      document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('demoStartBtn').addEventListener('click', startDemo);
        document.getElementById('demoStopBtn').addEventListener('click', stopDemo);
        document.getElementById('demoResetBtn').addEventListener('click', resetDemo);
        document.getElementById('newPieceBtn').addEventListener('click', forceNewPiece);
        document.getElementById('speedSelect').addEventListener('change', applySpeedFromSelect);
        applySpeedFromSelect();
      });
    </script>
  </head>
  <body>
    <header>
      <h1>üéÆ Blockout 3D - Demo Bot Visual Completo</h1>
      <p class="tip">Activa la consola del navegador para seguir la secuencia completa de logs y animaciones.</p>
    </header>

    <section id="hud">
      <span id="score">0</span>
      <span id="fps">FPS: 0</span>
    </section>

    <section id="controls">
      <button id="demoStartBtn">üöÄ Iniciar Demo</button>
      <button id="demoStopBtn" class="on">‚èπÔ∏è Detener</button>
      <button id="demoResetBtn">üîÑ Reset</button>
      <button id="newPieceBtn">üé≤ Nueva Pieza</button>
      <label>
        Pozo:
        <select id="pitSizeSelect" onchange="applyPitFromSelect()">
          <option value="5x5x10" selected>5x5x10</option>
          <option value="6x6x12">6x6x12</option>
          <option value="8x8x12">8x8x12</option>
        </select>
      </label>
      <label>
        Velocidad:
        <select id="speedSelect">
          <option value="slow">Lenta (1 FPS)</option>
          <option value="medium" selected>Media (2 FPS)</option>
          <option value="fast">R√°pida (4 FPS)</option>
        </select>
      </label>
    </section>

    <section id="game-wrapper">
      <canvas id="screen" width="500" height="500"></canvas>
      <canvas id="screen2" width="90" height="500"></canvas>
    </section>

    <section id="log-sequence">
      <h2>üìä Secuencia de Logs Esperada</h2>
      <code>[SYNC] Nueva pieza generada - Mostrando inmediatamente...</code>
      <code>[DemoBot] üéØ Iniciando evaluaci√≥n exhaustiva con animaciones visibles...</code>
      <code>[DemoBot] ‚úÖ Evaluaci√≥n completada - Probadas N posiciones. Mejor score: X.XXX</code>
      <code>[DemoBot] üéØ Destino final calculado: (x,y,z) con √°ngulos [AX,AY,AZ]¬∞</code>
      <code>Pieza ha llegado al fondo del pozo. Haciendo touchdown...</code>
      <code>[SYNC] Touchdown completado exitosamente - Pieza colocada en posici√≥n final</code>
      <p class="tip">
        Si aparece un error de evaluaci√≥n, revisa las capas del pozo; el sistema reportar√° inmediatamente si no existen posiciones v√°lidas.
      </p>
    </section>
  </body>
</html>
